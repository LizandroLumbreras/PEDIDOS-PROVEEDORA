<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>üì¶ Crear Pedido</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    h1, h2 { text-align: center; }
    form {
      background: #fff; padding: 20px; border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,.2); max-width: 600px; margin: 20px auto;
    }
    input, select, button {
      display: block; width: 100%; margin: 10px 0; padding: 10px;
      border: 1px solid #ccc; border-radius: 6px;
    }
    button { background: #28a745; color: white; border: none; cursor: pointer; }
    ul { background: white; padding: 10px; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>üì¶ Crear Pedido</h1>

  <!-- Formulario principal de pedido -->
  <form id="formPedido">
    <input type="text" id="cliente" placeholder="Cliente" required>
    <input type="text" id="libre" placeholder="Dato libre (opcional)">
    <select id="pago" required>
      <option value="">-- Forma de pago --</option>
      <option value="efectivo">efectivo</option>
      <option value="tarjeta">tarjeta</option>
      <option value="transferencia">transferencia</option>
      <option value="remision">remision</option>
      <option value="factura">factura</option>
      <option value="credito">credito</option>
    </select>
    <select id="chofer" required>
      <option value="">-- Chofer --</option>
      <option value="pedro damian elizondo irachetay">pedro damian elizondo irachetay</option>
      <option value="sergio becerra maravilla">sergio becerra maravilla</option>
    </select>
    <button type="submit">‚úÖ Crear Pedido</button>
  </form>

  <!-- Secci√≥n para art√≠culos -->
  <div id="seccionArticulos" style="display:none;">
    <h2>üõí Agregar art√≠culos</h2>
    <form id="formArticulo">
      <input type="number" id="cantidadArticulo" placeholder="Cantidad" required>
      <input type="text" id="descripcionArticulo" placeholder="Descripci√≥n del producto" required>
      <button type="submit">‚ûï Agregar Producto</button>
    </form>

    <h3>Art√≠culos agregados:</h3>
    <ul id="listaArticulos"></ul>
  </div>

  <script>
    // Conexi√≥n a Supabase
    const supabase = window.supabase.createClient(
      "https://cvpbtjlupswbyxenugpz.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"
    );

    let pedidoId = null;

    // Crear pedido
    document.getElementById("formPedido").addEventListener("submit", async (e) => {
      e.preventDefault();

      const cliente = document.getElementById("cliente").value;
      const libre = document.getElementById("libre").value;
      const pago = document.getElementById("pago").value;
      const chofer = document.getElementById("chofer").value;

      const { data, error } = await supabase.from("pedidos").insert([{
        cliente, libre, pago, chofer, cantidad: 0, total: 0, fecha: new Date()
      }]).select("id");

      if (error) {
        alert("‚ùå Error al crear pedido: " + error.message);
      } else {
        pedidoId = data[0].id;
        alert("‚úÖ Pedido creado. Ahora agrega los productos.");
        document.getElementById("formPedido").reset();
        document.getElementById("seccionArticulos").style.display = "block";
      }
    });

    // Agregar art√≠culos
    document.getElementById("formArticulo").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!pedidoId) {
        alert("Primero crea un pedido.");
        return;
      }

      const cantidad = parseFloat(document.getElementById("cantidadArticulo").value);
      const descripcion = document.getElementById("descripcionArticulo").value;

      const { error } = await supabase.from("pedidos_detalle").insert([{
        pedido_id: pedidoId, cantidad, descripcion
      }]);

      if (error) {
        alert("‚ùå Error al guardar detalle: " + error.message);
      } else {
        const li = document.createElement("li");
        li.textContent = `${cantidad} √ó ${descripcion}`;
        document.getElementById("listaArticulos").appendChild(li);
        document.getElementById("formArticulo").reset();
      }
    });
  </script>
</body>
</html>
